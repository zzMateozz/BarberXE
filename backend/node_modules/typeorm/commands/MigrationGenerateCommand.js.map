{"version":3,"sources":["../../src/commands/MigrationGenerateCommand.ts"],"names":[],"mappings":"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","file":"MigrationGenerateCommand.js","sourcesContent":["import { format } from \"@sqltools/formatter/lib/sqlFormatter\"\r\nimport ansi from \"ansis\"\r\nimport path from \"path\"\r\nimport process from \"process\"\r\nimport yargs from \"yargs\"\r\nimport { DataSource } from \"../data-source\"\r\nimport { PlatformTools } from \"../platform/PlatformTools\"\r\nimport { camelCase } from \"../util/StringUtils\"\r\nimport { CommandUtils } from \"./CommandUtils\"\r\n\r\n/**\r\n * Generates a new migration file with sql needs to be executed to update schema.\r\n */\r\nexport class MigrationGenerateCommand implements yargs.CommandModule {\r\n    command = \"migration:generate <path>\"\r\n    describe =\r\n        \"Generates a new migration file with sql needs to be executed to update schema.\"\r\n\r\n    builder(args: yargs.Argv) {\r\n        return args\r\n            .positional(\"path\", {\r\n                type: \"string\",\r\n                describe: \"Path of the migration file\",\r\n                demandOption: true,\r\n            })\r\n            .option(\"dataSource\", {\r\n                alias: \"d\",\r\n                type: \"string\",\r\n                describe:\r\n                    \"Path to the file where your DataSource instance is defined.\",\r\n                demandOption: true,\r\n            })\r\n            .option(\"p\", {\r\n                alias: \"pretty\",\r\n                type: \"boolean\",\r\n                default: false,\r\n                describe: \"Pretty-print generated SQL\",\r\n            })\r\n            .option(\"o\", {\r\n                alias: \"outputJs\",\r\n                type: \"boolean\",\r\n                default: false,\r\n                describe:\r\n                    \"Generate a migration file on Javascript instead of Typescript\",\r\n            })\r\n            .option(\"dr\", {\r\n                alias: \"dryrun\",\r\n                type: \"boolean\",\r\n                default: false,\r\n                describe:\r\n                    \"Prints out the contents of the migration instead of writing it to a file\",\r\n            })\r\n            .option(\"ch\", {\r\n                alias: \"check\",\r\n                type: \"boolean\",\r\n                default: false,\r\n                describe:\r\n                    \"Verifies that the current database is up to date and that no migrations are needed. Otherwise exits with code 1.\",\r\n            })\r\n            .option(\"t\", {\r\n                alias: \"timestamp\",\r\n                type: \"number\",\r\n                default: false,\r\n                describe: \"Custom timestamp for the migration name\",\r\n            })\r\n    }\r\n\r\n    async handler(args: yargs.Arguments<any & { path: string }>) {\r\n        const timestamp = CommandUtils.getTimestamp(args.timestamp)\r\n        const extension = args.outputJs ? \".js\" : \".ts\"\r\n        const fullPath = args.path.startsWith(\"/\")\r\n            ? args.path\r\n            : path.resolve(process.cwd(), args.path)\r\n        const filename = timestamp + \"-\" + path.basename(fullPath) + extension\r\n\r\n        let dataSource: DataSource | undefined = undefined\r\n        try {\r\n            dataSource = await CommandUtils.loadDataSource(\r\n                path.resolve(process.cwd(), args.dataSource as string),\r\n            )\r\n            dataSource.setOptions({\r\n                synchronize: false,\r\n                migrationsRun: false,\r\n                dropSchema: false,\r\n                logging: false,\r\n            })\r\n            await dataSource.initialize()\r\n\r\n            const upSqls: string[] = [],\r\n                downSqls: string[] = []\r\n\r\n            try {\r\n                const sqlInMemory = await dataSource.driver\r\n                    .createSchemaBuilder()\r\n                    .log()\r\n\r\n                if (args.pretty) {\r\n                    sqlInMemory.upQueries.forEach((upQuery) => {\r\n                        upQuery.query = MigrationGenerateCommand.prettifyQuery(\r\n                            upQuery.query,\r\n                        )\r\n                    })\r\n                    sqlInMemory.downQueries.forEach((downQuery) => {\r\n                        downQuery.query =\r\n                            MigrationGenerateCommand.prettifyQuery(\r\n                                downQuery.query,\r\n                            )\r\n                    })\r\n                }\r\n\r\n                sqlInMemory.upQueries.forEach((upQuery) => {\r\n                    upSqls.push(\r\n                        \"        await queryRunner.query(`\" +\r\n                            upQuery.query.replace(new RegExp(\"`\", \"g\"), \"\\\\`\") +\r\n                            \"`\" +\r\n                            MigrationGenerateCommand.queryParams(\r\n                                upQuery.parameters,\r\n                            ) +\r\n                            \");\",\r\n                    )\r\n                })\r\n                sqlInMemory.downQueries.forEach((downQuery) => {\r\n                    downSqls.push(\r\n                        \"        await queryRunner.query(`\" +\r\n                            downQuery.query.replace(\r\n                                new RegExp(\"`\", \"g\"),\r\n                                \"\\\\`\",\r\n                            ) +\r\n                            \"`\" +\r\n                            MigrationGenerateCommand.queryParams(\r\n                                downQuery.parameters,\r\n                            ) +\r\n                            \");\",\r\n                    )\r\n                })\r\n            } finally {\r\n                await dataSource.destroy()\r\n            }\r\n\r\n            if (!upSqls.length) {\r\n                if (args.check) {\r\n                    console.log(\r\n                        ansi.green`No changes in database schema were found`,\r\n                    )\r\n                    process.exit(0)\r\n                } else {\r\n                    console.log(\r\n                        ansi.yellow`No changes in database schema were found - cannot generate a migration. To create a new empty migration use \"typeorm migration:create\" command`,\r\n                    )\r\n                    process.exit(1)\r\n                }\r\n            } else if (!args.path) {\r\n                console.log(ansi.yellow`Please specify a migration path`)\r\n                process.exit(1)\r\n            }\r\n\r\n            const fileContent = args.outputJs\r\n                ? MigrationGenerateCommand.getJavascriptTemplate(\r\n                      path.basename(fullPath),\r\n                      timestamp,\r\n                      upSqls,\r\n                      downSqls.reverse(),\r\n                  )\r\n                : MigrationGenerateCommand.getTemplate(\r\n                      path.basename(fullPath),\r\n                      timestamp,\r\n                      upSqls,\r\n                      downSqls.reverse(),\r\n                  )\r\n\r\n            if (args.check) {\r\n                console.log(\r\n                    ansi.yellow`Unexpected changes in database schema were found in check mode:\\n\\n${ansi.white(\r\n                        fileContent,\r\n                    )}`,\r\n                )\r\n                process.exit(1)\r\n            }\r\n\r\n            if (args.dryrun) {\r\n                console.log(\r\n                    ansi.green(\r\n                        `Migration ${ansi.blue(\r\n                            fullPath + extension,\r\n                        )} has content:\\n\\n${ansi.white(fileContent)}`,\r\n                    ),\r\n                )\r\n            } else {\r\n                const migrationFileName =\r\n                    path.dirname(fullPath) + \"/\" + filename\r\n                await CommandUtils.createFile(migrationFileName, fileContent)\r\n\r\n                console.log(\r\n                    ansi.green`Migration ${ansi.blue(\r\n                        migrationFileName,\r\n                    )} has been generated successfully.`,\r\n                )\r\n                if (args.exitProcess !== false) {\r\n                    process.exit(0)\r\n                }\r\n            }\r\n        } catch (err) {\r\n            PlatformTools.logCmdErr(\"Error during migration generation:\", err)\r\n            process.exit(1)\r\n        }\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Protected Static Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Formats query parameters for migration queries if parameters actually exist\r\n     */\r\n    protected static queryParams(parameters: any[] | undefined): string {\r\n        if (!parameters || !parameters.length) {\r\n            return \"\"\r\n        }\r\n\r\n        return `, ${JSON.stringify(parameters)}`\r\n    }\r\n\r\n    /**\r\n     * Gets contents of the migration file.\r\n     */\r\n    protected static getTemplate(\r\n        name: string,\r\n        timestamp: number,\r\n        upSqls: string[],\r\n        downSqls: string[],\r\n    ): string {\r\n        const migrationName = `${camelCase(name, true)}${timestamp}`\r\n\r\n        return `import { MigrationInterface, QueryRunner } from \"typeorm\";\r\n\r\nexport class ${migrationName} implements MigrationInterface {\r\n    name = '${migrationName}'\r\n\r\n    public async up(queryRunner: QueryRunner): Promise<void> {\r\n${upSqls.join(`\r\n`)}\r\n    }\r\n\r\n    public async down(queryRunner: QueryRunner): Promise<void> {\r\n${downSqls.join(`\r\n`)}\r\n    }\r\n\r\n}\r\n`\r\n    }\r\n\r\n    /**\r\n     * Gets contents of the migration file in Javascript.\r\n     */\r\n    protected static getJavascriptTemplate(\r\n        name: string,\r\n        timestamp: number,\r\n        upSqls: string[],\r\n        downSqls: string[],\r\n    ): string {\r\n        const migrationName = `${camelCase(name, true)}${timestamp}`\r\n\r\n        return `const { MigrationInterface, QueryRunner } = require(\"typeorm\");\r\n\r\nmodule.exports = class ${migrationName} {\r\n    name = '${migrationName}'\r\n\r\n    async up(queryRunner) {\r\n${upSqls.join(`\r\n`)}\r\n    }\r\n\r\n    async down(queryRunner) {\r\n${downSqls.join(`\r\n`)}\r\n    }\r\n}\r\n`\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    protected static prettifyQuery(query: string) {\r\n        const formattedQuery = format(query, { indent: \"    \" })\r\n        return (\r\n            \"\\n\" + formattedQuery.replace(/^/gm, \"            \") + \"\\n        \"\r\n        )\r\n    }\r\n}\r\n"],"sourceRoot":".."}