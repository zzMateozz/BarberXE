{"version":3,"sources":["../../src/cache/DbQueryResultCache.ts"],"names":[],"mappings":"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","file":"DbQueryResultCache.js","sourcesContent":["import { ObjectLiteral } from \"../common/ObjectLiteral\"\r\nimport { DataSource } from \"../data-source/DataSource\"\r\nimport { MssqlParameter } from \"../driver/sqlserver/MssqlParameter\"\r\nimport { QueryRunner } from \"../query-runner/QueryRunner\"\r\nimport { Table } from \"../schema-builder/table/Table\"\r\nimport { QueryResultCache } from \"./QueryResultCache\"\r\nimport { QueryResultCacheOptions } from \"./QueryResultCacheOptions\"\r\nimport { v4 as uuidv4 } from \"uuid\"\r\n\r\n/**\r\n * Caches query result into current database, into separate table called \"query-result-cache\".\r\n */\r\nexport class DbQueryResultCache implements QueryResultCache {\r\n    // -------------------------------------------------------------------------\r\n    // Private properties\r\n    // -------------------------------------------------------------------------\r\n\r\n    private queryResultCacheTable: string\r\n\r\n    private queryResultCacheDatabase?: string\r\n\r\n    private queryResultCacheSchema?: string\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Constructor\r\n    // -------------------------------------------------------------------------\r\n\r\n    constructor(protected connection: DataSource) {\r\n        const { schema } = this.connection.driver.options as any\r\n        const database = this.connection.driver.database\r\n        const cacheOptions =\r\n            typeof this.connection.options.cache === \"object\"\r\n                ? this.connection.options.cache\r\n                : {}\r\n        const cacheTableName = cacheOptions.tableName || \"query-result-cache\"\r\n\r\n        this.queryResultCacheDatabase = database\r\n        this.queryResultCacheSchema = schema\r\n        this.queryResultCacheTable = this.connection.driver.buildTableName(\r\n            cacheTableName,\r\n            schema,\r\n            database,\r\n        )\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Public Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Creates a connection with given cache provider.\r\n     */\r\n    async connect(): Promise<void> {}\r\n\r\n    /**\r\n     * Disconnects with given cache provider.\r\n     */\r\n    async disconnect(): Promise<void> {}\r\n\r\n    /**\r\n     * Creates table for storing cache if it does not exist yet.\r\n     */\r\n    async synchronize(queryRunner?: QueryRunner): Promise<void> {\r\n        queryRunner = this.getQueryRunner(queryRunner)\r\n        const driver = this.connection.driver\r\n        const tableExist = await queryRunner.hasTable(\r\n            this.queryResultCacheTable,\r\n        ) // todo: table name should be configurable\r\n        if (tableExist) return\r\n\r\n        await queryRunner.createTable(\r\n            new Table({\r\n                database: this.queryResultCacheDatabase,\r\n                schema: this.queryResultCacheSchema,\r\n                name: this.queryResultCacheTable,\r\n                columns: [\r\n                    {\r\n                        name: \"id\",\r\n                        isPrimary: true,\r\n                        isNullable: false,\r\n                        type: driver.normalizeType({\r\n                            type: driver.mappedDataTypes.cacheId,\r\n                        }),\r\n                        generationStrategy:\r\n                            driver.options.type === \"spanner\"\r\n                                ? \"uuid\"\r\n                                : \"increment\",\r\n                        isGenerated: true,\r\n                    },\r\n                    {\r\n                        name: \"identifier\",\r\n                        type: driver.normalizeType({\r\n                            type: driver.mappedDataTypes.cacheIdentifier,\r\n                        }),\r\n                        isNullable: true,\r\n                    },\r\n                    {\r\n                        name: \"time\",\r\n                        type: driver.normalizeType({\r\n                            type: driver.mappedDataTypes.cacheTime,\r\n                        }),\r\n                        isPrimary: false,\r\n                        isNullable: false,\r\n                    },\r\n                    {\r\n                        name: \"duration\",\r\n                        type: driver.normalizeType({\r\n                            type: driver.mappedDataTypes.cacheDuration,\r\n                        }),\r\n                        isPrimary: false,\r\n                        isNullable: false,\r\n                    },\r\n                    {\r\n                        name: \"query\",\r\n                        type: driver.normalizeType({\r\n                            type: driver.mappedDataTypes.cacheQuery,\r\n                        }),\r\n                        isPrimary: false,\r\n                        isNullable: false,\r\n                    },\r\n                    {\r\n                        name: \"result\",\r\n                        type: driver.normalizeType({\r\n                            type: driver.mappedDataTypes.cacheResult,\r\n                        }),\r\n                        isNullable: false,\r\n                    },\r\n                ],\r\n            }),\r\n        )\r\n    }\r\n\r\n    /**\r\n     * Get data from cache.\r\n     * Returns cache result if found.\r\n     * Returns undefined if result is not cached.\r\n     */\r\n    getFromCache(\r\n        options: QueryResultCacheOptions,\r\n        queryRunner?: QueryRunner,\r\n    ): Promise<QueryResultCacheOptions | undefined> {\r\n        queryRunner = this.getQueryRunner(queryRunner)\r\n        const qb = this.connection\r\n            .createQueryBuilder(queryRunner)\r\n            .select()\r\n            .from(this.queryResultCacheTable, \"cache\")\r\n\r\n        if (options.identifier) {\r\n            return qb\r\n                .where(\r\n                    `${qb.escape(\"cache\")}.${qb.escape(\r\n                        \"identifier\",\r\n                    )} = :identifier`,\r\n                )\r\n                .setParameters({\r\n                    identifier:\r\n                        this.connection.driver.options.type === \"mssql\"\r\n                            ? new MssqlParameter(options.identifier, \"nvarchar\")\r\n                            : options.identifier,\r\n                })\r\n                .cache(false) // disable cache to avoid infinite loops when cache is alwaysEnable\r\n                .getRawOne()\r\n        } else if (options.query) {\r\n            if (this.connection.driver.options.type === \"oracle\") {\r\n                return qb\r\n                    .where(\r\n                        `dbms_lob.compare(${qb.escape(\"cache\")}.${qb.escape(\r\n                            \"query\",\r\n                        )}, :query) = 0`,\r\n                        { query: options.query },\r\n                    )\r\n                    .cache(false) // disable cache to avoid infinite loops when cache is alwaysEnable\r\n                    .getRawOne()\r\n            }\r\n\r\n            return qb\r\n                .where(`${qb.escape(\"cache\")}.${qb.escape(\"query\")} = :query`)\r\n                .setParameters({\r\n                    query:\r\n                        this.connection.driver.options.type === \"mssql\"\r\n                            ? new MssqlParameter(options.query, \"nvarchar\")\r\n                            : options.query,\r\n                })\r\n                .cache(false) // disable cache to avoid infinite loops when cache is alwaysEnable\r\n                .getRawOne()\r\n        }\r\n\r\n        return Promise.resolve(undefined)\r\n    }\r\n\r\n    /**\r\n     * Checks if cache is expired or not.\r\n     */\r\n    isExpired(savedCache: QueryResultCacheOptions): boolean {\r\n        const duration =\r\n            typeof savedCache.duration === \"string\"\r\n                ? parseInt(savedCache.duration)\r\n                : savedCache.duration\r\n        return (\r\n            (typeof savedCache.time === \"string\"\r\n                ? parseInt(savedCache.time as any)\r\n                : savedCache.time)! +\r\n                duration <\r\n            new Date().getTime()\r\n        )\r\n    }\r\n\r\n    /**\r\n     * Stores given query result in the cache.\r\n     */\r\n    async storeInCache(\r\n        options: QueryResultCacheOptions,\r\n        savedCache: QueryResultCacheOptions | undefined,\r\n        queryRunner?: QueryRunner,\r\n    ): Promise<void> {\r\n        const shouldCreateQueryRunner =\r\n            queryRunner === undefined ||\r\n            queryRunner?.getReplicationMode() === \"slave\"\r\n\r\n        if (queryRunner === undefined || shouldCreateQueryRunner) {\r\n            queryRunner = this.connection.createQueryRunner(\"master\")\r\n        }\r\n\r\n        let insertedValues: ObjectLiteral = options\r\n        if (this.connection.driver.options.type === \"mssql\") {\r\n            // todo: bad abstraction, re-implement this part, probably better if we create an entity metadata for cache table\r\n            insertedValues = {\r\n                identifier: new MssqlParameter(options.identifier, \"nvarchar\"),\r\n                time: new MssqlParameter(options.time, \"bigint\"),\r\n                duration: new MssqlParameter(options.duration, \"int\"),\r\n                query: new MssqlParameter(options.query, \"nvarchar\"),\r\n                result: new MssqlParameter(options.result, \"nvarchar\"),\r\n            }\r\n        }\r\n\r\n        if (savedCache && savedCache.identifier) {\r\n            // if exist then update\r\n            const qb = queryRunner.manager\r\n                .createQueryBuilder()\r\n                .update(this.queryResultCacheTable)\r\n                .set(insertedValues)\r\n\r\n            qb.where(`${qb.escape(\"identifier\")} = :condition`, {\r\n                condition: insertedValues.identifier,\r\n            })\r\n            await qb.execute()\r\n        } else if (savedCache && savedCache.query) {\r\n            // if exist then update\r\n            const qb = queryRunner.manager\r\n                .createQueryBuilder()\r\n                .update(this.queryResultCacheTable)\r\n                .set(insertedValues)\r\n\r\n            if (this.connection.driver.options.type === \"oracle\") {\r\n                qb.where(`dbms_lob.compare(\"query\", :condition) = 0`, {\r\n                    condition: insertedValues.query,\r\n                })\r\n            } else {\r\n                qb.where(`${qb.escape(\"query\")} = :condition`, {\r\n                    condition: insertedValues.query,\r\n                })\r\n            }\r\n\r\n            await qb.execute()\r\n        } else {\r\n            // Spanner does not support auto-generated columns\r\n            if (\r\n                this.connection.driver.options.type === \"spanner\" &&\r\n                !insertedValues.id\r\n            ) {\r\n                insertedValues.id = uuidv4()\r\n            }\r\n\r\n            // otherwise insert\r\n            await queryRunner.manager\r\n                .createQueryBuilder()\r\n                .insert()\r\n                .into(this.queryResultCacheTable)\r\n                .values(insertedValues)\r\n                .execute()\r\n        }\r\n\r\n        if (shouldCreateQueryRunner) {\r\n            await queryRunner.release()\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clears everything stored in the cache.\r\n     */\r\n    async clear(queryRunner: QueryRunner): Promise<void> {\r\n        return this.getQueryRunner(queryRunner).clearTable(\r\n            this.queryResultCacheTable,\r\n        )\r\n    }\r\n\r\n    /**\r\n     * Removes all cached results by given identifiers from cache.\r\n     */\r\n    async remove(\r\n        identifiers: string[],\r\n        queryRunner?: QueryRunner,\r\n    ): Promise<void> {\r\n        let _queryRunner: QueryRunner = queryRunner || this.getQueryRunner()\r\n        await Promise.all(\r\n            identifiers.map((identifier) => {\r\n                const qb = _queryRunner.manager.createQueryBuilder()\r\n                return qb\r\n                    .delete()\r\n                    .from(this.queryResultCacheTable)\r\n                    .where(`${qb.escape(\"identifier\")} = :identifier`, {\r\n                        identifier,\r\n                    })\r\n                    .execute()\r\n            }),\r\n        )\r\n\r\n        if (!queryRunner) {\r\n            await _queryRunner.release()\r\n        }\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Protected Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Gets a query runner to work with.\r\n     */\r\n    protected getQueryRunner(queryRunner?: QueryRunner): QueryRunner {\r\n        if (queryRunner) return queryRunner\r\n\r\n        return this.connection.createQueryRunner()\r\n    }\r\n}\r\n"],"sourceRoot":".."}