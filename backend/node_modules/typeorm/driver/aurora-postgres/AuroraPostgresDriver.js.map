{"version":3,"sources":["../../src/driver/aurora-postgres/AuroraPostgresDriver.ts"],"names":[],"mappings":"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","file":"AuroraPostgresDriver.js","sourcesContent":["import { Driver } from \"../Driver\"\r\nimport { PostgresDriver } from \"../postgres/PostgresDriver\"\r\nimport { PlatformTools } from \"../../platform/PlatformTools\"\r\nimport { DataSource } from \"../../data-source/DataSource\"\r\nimport { AuroraPostgresConnectionOptions } from \"./AuroraPostgresConnectionOptions\"\r\nimport { AuroraPostgresQueryRunner } from \"./AuroraPostgresQueryRunner\"\r\nimport { ReplicationMode } from \"../types/ReplicationMode\"\r\nimport { ColumnMetadata } from \"../../metadata/ColumnMetadata\"\r\nimport { ApplyValueTransformers } from \"../../util/ApplyValueTransformers\"\r\nimport { DriverUtils } from \"../DriverUtils\"\r\n\r\nabstract class PostgresWrapper extends PostgresDriver {\r\n    options: any\r\n\r\n    abstract createQueryRunner(mode: ReplicationMode): any\r\n}\r\n\r\nexport class AuroraPostgresDriver extends PostgresWrapper implements Driver {\r\n    // -------------------------------------------------------------------------\r\n    // Public Properties\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Connection used by driver.\r\n     */\r\n    connection: DataSource\r\n\r\n    /**\r\n     * Aurora Data API underlying library.\r\n     */\r\n    DataApiDriver: any\r\n\r\n    client: any\r\n\r\n    /**\r\n     * Represent transaction support by this driver\r\n     */\r\n    transactionSupport = \"nested\" as const\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Public Implemented Properties\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Connection options.\r\n     */\r\n    options: AuroraPostgresConnectionOptions\r\n\r\n    /**\r\n     * Master database used to perform all write queries.\r\n     */\r\n    database?: string\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Constructor\r\n    // -------------------------------------------------------------------------\r\n\r\n    constructor(connection: DataSource) {\r\n        super()\r\n        this.connection = connection\r\n        this.options = connection.options as AuroraPostgresConnectionOptions\r\n        this.isReplicated = false\r\n\r\n        // load data-api package\r\n        this.loadDependencies()\r\n\r\n        this.client = new this.DataApiDriver(\r\n            this.options.region,\r\n            this.options.secretArn,\r\n            this.options.resourceArn,\r\n            this.options.database,\r\n            (query: string, parameters?: any[]) =>\r\n                this.connection.logger.logQuery(query, parameters),\r\n            this.options.serviceConfigOptions,\r\n            this.options.formatOptions,\r\n        )\r\n\r\n        this.database = DriverUtils.buildDriverOptions(this.options).database\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Public Implemented Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Performs connection to the database.\r\n     * Based on pooling options, it can either create connection immediately,\r\n     * either create a pool and create connection when needed.\r\n     */\r\n    async connect(): Promise<void> {}\r\n\r\n    /**\r\n     * Closes connection with database.\r\n     */\r\n    async disconnect(): Promise<void> {}\r\n\r\n    /**\r\n     * Creates a query runner used to execute database queries.\r\n     */\r\n    createQueryRunner(mode: ReplicationMode) {\r\n        return new AuroraPostgresQueryRunner(\r\n            this,\r\n            new this.DataApiDriver(\r\n                this.options.region,\r\n                this.options.secretArn,\r\n                this.options.resourceArn,\r\n                this.options.database,\r\n                (query: string, parameters?: any[]) =>\r\n                    this.connection.logger.logQuery(query, parameters),\r\n                this.options.serviceConfigOptions,\r\n                this.options.formatOptions,\r\n            ),\r\n            mode,\r\n        )\r\n    }\r\n\r\n    /**\r\n     * Prepares given value to a value to be persisted, based on its column type and metadata.\r\n     */\r\n    preparePersistentValue(value: any, columnMetadata: ColumnMetadata): any {\r\n        if (\r\n            this.options.formatOptions &&\r\n            this.options.formatOptions.castParameters === false\r\n        ) {\r\n            return super.preparePersistentValue(value, columnMetadata)\r\n        }\r\n\r\n        if (columnMetadata.transformer)\r\n            value = ApplyValueTransformers.transformTo(\r\n                columnMetadata.transformer,\r\n                value,\r\n            )\r\n\r\n        return this.client.preparePersistentValue(value, columnMetadata)\r\n    }\r\n\r\n    /**\r\n     * Prepares given value to a value to be persisted, based on its column type and metadata.\r\n     */\r\n    prepareHydratedValue(value: any, columnMetadata: ColumnMetadata): any {\r\n        if (\r\n            this.options.formatOptions &&\r\n            this.options.formatOptions.castParameters === false\r\n        ) {\r\n            return super.prepareHydratedValue(value, columnMetadata)\r\n        }\r\n\r\n        if (columnMetadata.transformer)\r\n            value = ApplyValueTransformers.transformFrom(\r\n                columnMetadata.transformer,\r\n                value,\r\n            )\r\n\r\n        return this.client.prepareHydratedValue(value, columnMetadata)\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Protected Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * If driver dependency is not given explicitly, then try to load it via \"require\".\r\n     */\r\n    protected loadDependencies(): void {\r\n        const driver =\r\n            this.options.driver ||\r\n            PlatformTools.load(\"typeorm-aurora-data-api-driver\")\r\n        const { pg } = driver\r\n\r\n        this.DataApiDriver = pg\r\n    }\r\n\r\n    /**\r\n     * Executes given query.\r\n     */\r\n    protected executeQuery(connection: any, query: string) {\r\n        return this.connection.query(query)\r\n    }\r\n\r\n    /**\r\n     * Makes any action after connection (e.g. create extensions in Postgres driver).\r\n     */\r\n    async afterConnect(): Promise<void> {\r\n        const extensionsMetadata = await this.checkMetadataForExtensions()\r\n\r\n        if (extensionsMetadata.hasExtensions) {\r\n            await this.enableExtensions(extensionsMetadata, this.connection)\r\n        }\r\n\r\n        return Promise.resolve()\r\n    }\r\n}\r\n"],"sourceRoot":"../.."}